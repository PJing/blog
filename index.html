<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
	<style type="text/css">
	body, html,#allmap {width: 100%;height: 500px;overflow: hidden;margin:0;font-family:"微软雅黑";}
	</style>
	<script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=0QvQZfWva3fm2882sGIaIC6UbRe81XfL"></script>
	<title>地图展示</title>
	<style type="text/css">
		.bottom{
			background-color: orange;
			margin-bottom: 10px;
		}
	</style>
</head>
<body>
	<div class="bottom">
		<input type="text" id="txt" />
		<button id='select'>搜索</button>
	</div>
	<div id="allmap"></div>
	
</body>
</html>
<script src="http://libs.baidu.com/jquery/2.0.0/jquery.min.js"></script>
<script type="text/javascript">
	var ak = '0QvQZfWva3fm2882sGIaIC6UbRe81XfL';
	
	//自定义我的位置图标
	var myIcon = new BMap.Icon("address.png",new BMap.Size(20,20));
	
	// 百度地图API功能
	var map = new BMap.Map("allmap");    // 创建Map实例
	map.centerAndZoom(new BMap.Point(114.311582,30.598467), 15);  // 初始化地图,设置中心点坐标和地图级别
	//添加地图类型控件
	map.addControl(new BMap.MapTypeControl({
		mapTypes:[
            BMAP_NORMAL_MAP,
            BMAP_HYBRID_MAP
        ]}));	  
	map.setCurrentCity("武汉");          // 设置地图显示的城市 此项是必须设置的
	map.enableScrollWheelZoom(true);     //开启鼠标滚轮缩放
	
	
	$("#select").on('click',function(){
		var keyword = $('#txt').val();
		getLocalAddress(keyword);
	})
	
	
	//页面加载时开始获取当前位置
	getCurrentAddress();
	
	//地图拖拽时加载视野内数据
	map.addEventListener("dragend",getrectangleAddress)
	
	//获取当前位置
	function getCurrentAddress(){
		//获取当前地理坐标
		var geolocation = new BMap.Geolocation();
		geolocation.getCurrentPosition(function(r){
			if(this.getStatus() == BMAP_STATUS_SUCCESS){
				var mk = new BMap.Marker(r.point,{icon:myIcon});
				map.addOverlay(mk);
				map.panTo(r.point);
				alert('您的位置：'+r.point.lng+','+r.point.lat);
				let addr =  r.point.lng+','+r.point.lat;
				getArroundAddress(addr)
			}
			else {
				alert('failed'+this.getStatus());
			}        
		},{enableHighAccuracy: true})
	}
	
	//本地检索
	function getLocalAddress(keyword){
		console.log(keyword)
		let url = 'http://api.map.baidu.com/geosearch/v3/local';
		$.ajax({
			type:"get",
			url:url,
			dataType:"jsonp",
			async:true,
			data:{
				'q': keyword, //检索关键字
                'page_index': 0,  //页码
                'region': '218',  //当前城市id
                'scope': '2',  //显示详细信息
                'geotable_id': 182572,
                'page_size': 12,
                'ak': ak,  //用户ak
			},
			success(res){
				console.log(res);
			}
		});
	}
	
	//矩形检索

	function getrectangleAddress(){
		let bs = map.getBounds();   //获取可视区域
	    let bssw = bs.getSouthWest();   //可视区域左下角
	    let bsne = bs.getNorthEast();   //可视区域右上角
//	    console.log(bssw,bsne);
	    let addr = bssw.lng + ','+ bssw.lat +';'+ bsne.lng +','+ bsne.lat
	    console.log(addr)
	    
	    let url = 'http://api.map.baidu.com/geosearch/v3/bound';
	    $.ajax({
	    	type:"get",
	    	url:url,
	    	dataType:"jsonp",
	    	async:true,
	    	data:{
				'q': '', //检索关键字
				'bounds':addr, //左下角和右上角的经纬度坐标点。2个点用;号分隔
                'page_index': 0,  //页码
                'region': '218',  //当前城市id
                'scope': '2',  //显示详细信息
                'geotable_id': 182572,
                'page_size': 12,
                'ak': ak,  //用户ak
			},
			success(res){
				console.log(res);
//				alert(JSON.stringify(res))
				if(res.size != 0){
					renderMap(res);
				}else{
					return;
				}
				
			}
	    });
	}
	
	
	//周边检索
	function getArroundAddress(addr,keyword){
		keyword = keyword || "";
		let url = "https://api.map.baidu.com/geosearch/v3/nearby";
		$.ajax({
			type:"get",
			url: url,
			dataType:"jsonp",
			async:true,
			data:{
				'location':addr,  // 当前地理坐标
				'q': keyword, //检索关键字
                'page_index': 0,  //页码
                // 'filter': filter.join('|'),  //过滤条件
                'region': '218',  //当前城市id
                'scope': '2',  //显示详细信息
                'geotable_id': 182572,
                'page_size': 12,
                'ak': ak,  //用户ak
                'radius':5000     //半径
			},
			success(res){
				console.log(res);
//				alert(JSON.stringify(res))
				renderMap(res);
			}
		});
	}
	
	//绘制坐标
	function renderMap(res){
		var content = res.contents;
		
		if(content.length == 0){
			alert("未查询到信息");
			return;
		}
		
		$.each(content,function(i,item){
			let point = new BMap.Point(item.location[0], item.location[1]);
			let marker = new BMap.Marker(point);
//			alert(JSON.stringify(item))
			map.addOverlay(marker);
			showInfo(marker,item)
		})
	}
	
	//点击marker显示详情
	function showInfo(marker,item){
		var opts = {
				width : 250,     // 信息窗口宽度
				height: 80,     // 信息窗口高度
				title : "信息窗口" , // 信息窗口标题

		   	};
		marker.addEventListener('click',function(){
            //创建检索信息窗口对象
            var point = new BMap.Point(item.location[0], item.location[1]);
            map.panTo({center: point,opts:true})
        	
           	var infoWindow = new BMap.InfoWindow(item.address, opts);  // 创建信息窗口对象 

			map.openInfoWindow(infoWindow,point); //开启信息窗口

		},false)
	}
	
	
</script>
